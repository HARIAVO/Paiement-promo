<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestion Paiements Étudiants - Médecine</title>
<style>
  /* Ton style validé, inchangé */
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');
  * { box-sizing: border-box; }
  body {
    margin:0; padding:0; background:#f4f9ff;
    font-family: 'Montserrat', sans-serif;
    color:#333;
    display:flex; justify-content:center; align-items:center;
    min-height:100vh;
  }
  #app {
    background:white;
    width:95vw;
    max-width:1000px;
    border-radius:15px;
    box-shadow:0 8px 20px rgb(0 123 255 / 0.2);
    overflow:hidden;
  }
  header {
    background:#007bff;
    color:white;
    padding:1rem 2rem;
    display:flex;
    align-items:center;
    gap:1rem;
    box-shadow: inset 0 -4px 8px rgb(0 0 0 / 0.1);
  }
  header svg {
    width:36px; height:36px;
    fill:#a6d8ff;
  }
  header h1 {
    font-weight:600;
    font-size:1.5rem;
    margin:0;
  }
  #loginSection, #mainSection {
    padding:1rem 2rem 2rem 2rem;
  }
  #loginSection {
    max-width:400px;
    margin:4rem auto;
    background:white;
    border-radius:15px;
    box-shadow:0 8px 20px rgb(0 123 255 / 0.15);
    text-align:center;
  }
  #loginSection h1 {
    margin-bottom:1.5rem;
    font-weight:600;
    color:#007bff;
  }
  #loginForm input {
    display:block;
    width:100%;
    margin-bottom:1rem;
    padding:0.8rem;
    font-size:1rem;
    border-radius:8px;
    border:1px solid #ccc;
    transition: border-color 0.3s;
  }
  #loginForm input:focus {
    outline:none;
    border-color:#007bff;
    box-shadow:0 0 6px #007bffaa;
  }
  #loginForm button {
    width:100%;
    background:#007bff;
    color:white;
    border:none;
    font-weight:600;
    font-size:1rem;
    padding:0.8rem;
    border-radius:8px;
    cursor:pointer;
    transition: background 0.3s;
  }
  #loginForm button:hover {
    background:#0056b3;
  }
  #loginError {
    color:#d9534f;
    margin-top:0.5rem;
    display:none;
  }
  #logoutBtn {
    background:#dc3545;
    color:white;
    border:none;
    border-radius:12px;
    padding:0.5rem 1rem;
    font-weight:600;
    cursor:pointer;
    float:right;
    margin-bottom:1rem;
    display:flex;
    align-items:center;
    gap:0.5rem;
    transition: background 0.3s;
  }
  #logoutBtn:hover {
    background:#b02a37;
  }
  #logoutBtn svg {
    width:20px; height:20px;
    fill:white;
  }
  nav {
    display:flex;
    gap:1rem;
    margin-bottom:1rem;
  }
  nav button {
    flex-grow:1;
    padding:0.8rem;
    background:#e7f0ff;
    border:none;
    border-radius:12px;
    font-weight:600;
    cursor:pointer;
    color:#007bff;
    transition: background 0.3s, color 0.3s;
  }
  nav button.active,
  nav button:hover {
    background:#007bff;
    color:white;
  }

  table {
    width:100%;
    border-collapse:collapse;
    margin-bottom:1rem;
    font-size:0.9rem;
  }
  th, td {
    text-align:center;
    padding:0.6rem 0.8rem;
    border-bottom:1px solid #ddd;
    vertical-align:middle;
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  tbody tr:hover {
    background:#f1f9ff;
  }
  td[contenteditable="true"] {
    background:#e7f0ff;
    border-radius:6px;
    cursor:text;
    font-family: monospace;
    text-align: right;
    padding-right: 10px;
  }
  td[contenteditable="true"]:focus {
    outline:2px solid #0056b3;
    background:#cce4ff;
  }
  tbody tr td[data-label="Nom et prénom"] {
    max-width: 200px;
    white-space: nowrap;
  }
  .btn-delete {
    background:#dc3545;
    border:none;
    color:white;
    padding:0.3rem 0.6rem;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    transition: background 0.3s;
  }
  .btn-delete:hover {
    background:#a71d2a;
  }

  form.addForm {
    display:flex;
    gap:0.6rem;
    flex-wrap:wrap;
    margin-bottom:2rem;
  }
  form.addForm input,
  form.addForm select,
  form.addForm button {
    padding:0.5rem 0.8rem;
    font-size:0.9rem;
    border-radius:8px;
    border:1px solid #ccc;
    flex:1 1 120px;
  }
  form.addForm button {
    background:#28a745;
    border:none;
    color:white;
    font-weight:600;
    cursor:pointer;
    flex:1 1 120px;
    transition: background 0.3s;
  }
  form.addForm button:hover {
    background:#1e7e34;
  }

  @media (max-width: 720px) {
    table, thead, tbody, th, td, tr {
      display:block;
    }
    thead tr {
      display:none;
    }
    tbody tr {
      margin-bottom:1rem;
      border-radius:12px;
      box-shadow:0 4px 8px rgb(0 123 255 / 0.1);
      background:white;
      padding:1rem;
    }
    tbody tr td {
      display:flex;
      justify-content:space-between;
      padding:0.6rem 1rem;
      border:none;
      border-bottom:1px solid #eee;
      text-align:left;
      white-space: normal;
    }
    tbody tr td:last-child {
      border-bottom:none;
    }
    tbody tr td::before {
      content: attr(data-label);
      font-weight:600;
      color:#007bff;
    }
    form.addForm {
      flex-direction:column;
    }
  }
</style>
</head>
<body>

<div id="app">
  <section id="loginSection" role="dialog" aria-modal="true" aria-labelledby="loginTitle" aria-describedby="loginDesc">
    <h1 id="loginTitle">Connexion requise</h1>
    <p id="loginDesc">Veuillez entrer votre matricule et mot de passe pour accéder au site.</p>
    <form id="loginForm" aria-label="Formulaire de connexion">
      <input type="text" id="loginMatricule" placeholder="Matricule" required autocomplete="off" aria-required="true" aria-label="Matricule" />
      <input type="password" id="loginPassword" placeholder="Mot de passe" required autocomplete="off" aria-required="true" aria-label="Mot de passe" />
      <button type="submit" aria-label="Se connecter">Se connecter</button>
    </form>
    <p id="loginError" role="alert" aria-live="assertive" style="display:none; color:#d9534f; margin-top:0.5rem;">Matricule ou mot de passe incorrect.</p>
  </section>

  <section id="mainSection" style="display:none;" aria-live="polite">

    <button id="logoutBtn" title="Déconnexion" aria-label="Bouton déconnexion" style="margin-bottom:1rem;">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" style="width:18px; height:18px; vertical-align:middle; margin-right:0.3rem;"><path d="M19 7v10a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2v-3H5v3a4 4 0 0 0 4 4h8a4 4 0 0 0 4-4V7z"/><path d="M16 12H7m5-5l-5 5 5 5" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Déconnexion
    </button>

    <header>
      <svg aria-hidden="true" focusable="false" viewBox="0 0 64 64" width="36" height="36" style="flex-shrink:0; margin-right:1rem;">
        <path d="M53.2 15.8a3 3 0 0 0-2.7-1.7 3 3 0 0 0-2.5 1.2l-4.4 6.1a.5.5 0 0 1-.87-.33l-1-7.2a3 3 0 0 0-1.6-2.5l-10-5.8a2.97 2.97 0 0 0-3 .5 2.96 2.96 0 0 0-.92 2.4l.15 12.4-11.4 7.7a2.94 2.94 0 0 0-1 2.2 2.95 2.95 0 0 0 2.9 2.9 2.9 2.9 0 0 0 1.7-.52l11.4-7.7v17.6a5 5 0 1 0 4 0V23.4l4.4-6.1a.5.5 0 0 1 .87.33l1 7.2a3 3 0 0 0 1.6 2.5l10 5.8a3.02 3.02 0 0 0 4.1-3.3z" fill="#3a9ad9"/>
      </svg>
      <h1>Gestion paiements étudiants</h1>
    </header>

    <nav role="tablist" aria-label="Navigation principale" style="margin:1rem 0;">
      <button id="btnGestion" class="active" aria-controls="gestionSection" aria-selected="true" role="tab" tabindex="0">Gestion</button>
      <button id="btnParams" style="display:none;" aria-controls="paramsSection" aria-selected="false" role="tab" tabindex="-1">Paramètres</button>
      <button id="btnHistory" style="display:none;" aria-controls="historySection" aria-selected="false" role="tab" tabindex="-1">Historique</button>
    </nav>

    <section id="gestionSection" role="tabpanel" tabindex="0" aria-label="Gestion des étudiants">
      <table aria-label="Liste des étudiants">
        <thead>
          <tr>
            <th>Nom et prénom</th>
            <th>Matricule</th>
            <th>2025 (Ar)</th>
            <th>2026 (Ar)</th>
            <th>2027 (Ar)</th>
            <th>2028 (Ar)</th>
            <th>Total (Ar)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="studentList"></tbody>
      </table>

      <form id="addStudentForm" class="addForm" aria-label="Formulaire d'ajout d'étudiant">
        <input type="text" id="addNom" placeholder="Nom et prénom" required autocomplete="off" aria-required="true" aria-label="Nom et prénom" />
        <input type="text" id="addMatricule" placeholder="Matricule" required autocomplete="off" aria-required="true" aria-label="Matricule" />
        <input type="number" id="add2025" placeholder="2025" min="0" value="0" required aria-label="Paiement 2025" />
        <input type="number" id="add2026" placeholder="2026" min="0" value="0" required aria-label="Paiement 2026" />
        <input type="number" id="add2027" placeholder="2027" min="0" value="0" required aria-label="Paiement 2027" />
        <input type="number" id="add2028" placeholder="2028" min="0" value="0" required aria-label="Paiement 2028" />
        <button type="submit" id="addStudentBtn">Ajouter</button>
      </form>
    </section>

    <section id="paramsSection" role="tabpanel" tabindex="0" style="display:none;" aria-label="Paramètres">
      <h2>Gestion des utilisateurs</h2>
      <table aria-label="Liste des utilisateurs">
        <thead>
          <tr>
            <th>Matricule</th>
            <th>Mot de passe</th>
            <th>Droits</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="userList"></tbody>
      </table>

      <form id="addUserForm" class="addForm" aria-label="Formulaire d'ajout d'utilisateur">
        <input type="text" id="addUserMatricule" placeholder="Matricule" required autocomplete="off" aria-required="true" aria-label="Matricule utilisateur" />
        <input type="password" id="addUserPassword" placeholder="Mot de passe" required autocomplete="off" aria-required="true" aria-label="Mot de passe utilisateur" />
        <select id="addUserRight" required aria-label="Droits utilisateur">
          <option value="" disabled selected>Choisir droits</option>
          <option value="edit">Peut modifier</option>
          <option value="read">Lecture seule</option>
        </select>
        <button type="submit" id="addUserBtn">Ajouter utilisateur</button>
      </form>
    </section>

    <section id="historySection" role="tabpanel" tabindex="0" style="display:none;" aria-label="Historique">
      <h2>Historique des modifications</h2>
      <ul id="historyList" style="max-height:300px;overflow:auto;padding-left:1rem;"></ul>
    </section>

  </section>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
  apiKey: "AIzaSyDW8_PXm8MpM-NSANtFqIL4egHN9DjtJUo",
  authDomain: "gestion-paiements-medecine.firebaseapp.com",
  databaseURL: "https://gestion-paiements-medecine-default-rtdb.firebaseio.com",
  projectId: "gestion-paiements-medecine",
  storageBucket: "gestion-paiements-medecine.firebasestorage.app",
  messagingSenderId: "973526886140",
  appId: "1:973526886140:web:fe49cdc9
    // databaseURL n'est pas nécessaire pour Firestore
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Variables globales
  let students = [];
  let users = {};
  let history = [];
  let currentUser = null;

  // Affiche l'heure locale de Madagascar au format court
  function formatMadagascarDate(d) {
    const utc = d.getTime() + (d.getTimezoneOffset() * 60000);
    const madagascarTime = new Date(utc + 3 * 60 * 60000);
    return madagascarTime.toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });
  }

  // --- Rendu HTML ---

  // Rendu étudiants dans le tableau
  function renderStudents() {
    students.sort((a, b) => a.nom.localeCompare(b.nom));
    const tbody = document.getElementById('studentList');
    tbody.innerHTML = '';

    students.forEach((s, idx) => {
      const total = (Number(s.p2025) || 0) + (Number(s.p2026) || 0) + (Number(s.p2027) || 0) + (Number(s.p2028) || 0);
      const tr = document.createElement('tr');
      tr.dataset.id = s.matricule;
      tr.innerHTML = `
        <td ${currentUser.canEdit ? 'contenteditable="true" aria-label="Nom et prénom de ' + s.nom + '"' : ''} data-label="Nom et prénom">${s.nom}</td>
        <td data-label="Matricule">${s.matricule}</td>
        <td ${currentUser.canEdit ? 'contenteditable="true" aria-label="Paiement 2025 de ' + s.nom + '"' : ''} data-label="2025 (Ar)">${s.p2025 || 0}</td>
        <td ${currentUser.canEdit ? 'contenteditable="true" aria-label="Paiement 2026 de ' + s.nom + '"' : ''} data-label="2026 (Ar)">${s.p2026 || 0}</td>
        <td ${currentUser.canEdit ? 'contenteditable="true" aria-label="Paiement 2027 de ' + s.nom + '"' : ''} data-label="2027 (Ar)">${s.p2027 || 0}</td>
        <td ${currentUser.canEdit ? 'contenteditable="true" aria-label="Paiement 2028 de ' + s.nom + '"' : ''} data-label="2028 (Ar)">${s.p2028 || 0}</td>
        <td data-label="Total (Ar)">${total}</td>
        <td>${currentUser.canEdit ? '<button class="btn-delete" aria-label="Supprimer ' + s.nom + '">Supprimer</button>' : ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Rendu utilisateurs
  function renderUsers() {
    const tbody = document.getElementById('userList');
    tbody.innerHTML = '';
    Object.entries(users).forEach(([matricule, user]) => {
      const tr = document.createElement('tr');
      tr.dataset.matricule = matricule;
      tr.innerHTML = `
        <td>${matricule}</td>
        <td>●●●●●●</td>
        <td>${user.right}</td>
        <td><button class="btn-delete" aria-label="Supprimer utilisateur ${matricule}">Supprimer</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Rendu historique
  function renderHistory() {
    const ul = document.getElementById('historyList');
    ul.innerHTML = '';
    history.slice().reverse().forEach(h => {
      const li = document.createElement('li');
      li.textContent = `[${formatMadagascarDate(new Date(h.date))}] ${h.user} a ${h.action}`;
      ul.appendChild(li);
    });
  }

  // --- Chargement données Firestore en temps réel ---

  function loadStudentsRealtime() {
    db.collection('students').onSnapshot(snapshot => {
      students = [];
      snapshot.forEach(doc => {
        students.push({ matricule: doc.id, ...doc.data() });
      });
      renderStudents();
    });
  }

  function loadUsersRealtime() {
    db.collection('users').onSnapshot(snapshot => {
      users = {};
      snapshot.forEach(doc => {
        users[doc.id] = doc.data();
      });
      renderUsers();
    });
  }

  function loadHistoryRealtime() {
    db.collection('history').orderBy('date', 'desc').limit(50).onSnapshot(snapshot => {
      history = [];
      snapshot.forEach(doc => {
        history.push(doc.data());
      });
      renderHistory();
    });
  }

  // --- Auth basique par Firestore (attention pas sécurisé, juste pour démo) ---
  function login(matricule, password) {
    if(users[matricule] && users[matricule].password === password) {
      currentUser = {
        matricule,
        canEdit: users[matricule].right === 'edit',
        right: users[matricule].right
      };
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      return true;
    }
    return false;
  }

  function logout() {
    currentUser = null;
    localStorage.removeItem('currentUser');
  }

  // --- Évènements ---

  document.getElementById('loginForm').addEventListener('submit', e => {
    e.preventDefault();
    const matricule = e.target.loginMatricule.value.trim();
    const password = e.target.loginPassword.value.trim();

    if(login(matricule, password)) {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('mainSection').style.display = 'block';
      document.getElementById('loginError').style.display = 'none';
      showTab('btnGestion');
      loadStudentsRealtime();
      loadUsersRealtime();
      loadHistoryRealtime();
    } else {
      document.getElementById('loginError').style.display = 'block';
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', () => {
    logout();
    location.reload();
  });

  // Ajout étudiant
  document.getElementById('addStudentForm').addEventListener('submit', e => {
    e.preventDefault();
    if(!currentUser || !currentUser.canEdit) return alert("Droits insuffisants");

    const nom = document.getElementById('addNom').value.trim();
    const matricule = document.getElementById('addMatricule').value.trim();
    const p2025 = Number(document.getElementById('add2025').value);
    const p2026 = Number(document.getElementById('add2026').value);
    const p2027 = Number(document.getElementById('add2027').value);
    const p2028 = Number(document.getElementById('add2028').value);

    if(!nom || !matricule) return alert("Nom et matricule sont requis");

    db.collection('students').doc(matricule).set({
      nom,
      p2025,
      p2026,
      p2027,
      p2028
    })
    .then(() => {
      addHistory(currentUser.matricule, `ajouté l'étudiant ${nom} (${matricule})`);
      e.target.reset();
    })
    .catch(err => {
      alert("Erreur ajout étudiant: " + err.message);
    });
  });

  // Ajout utilisateur
  document.getElementById('addUserForm').addEventListener('submit', e => {
    e.preventDefault();
    if(!currentUser || currentUser.right !== 'edit') return alert("Droits insuffisants");

    const matricule = document.getElementById('addUserMatricule').value.trim();
    const password = document.getElementById('addUserPassword').value.trim();
    const right = document.getElementById('addUserRight').value;

    if(!matricule || !password || !right) return alert("Tous les champs sont requis");

    db.collection('users').doc(matricule).set({
      password,
      right
    })
    .then(() => {
      addHistory(currentUser.matricule, `ajouté l'utilisateur ${matricule} avec droit ${right}`);
      e.target.reset();
    })
    .catch(err => {
      alert("Erreur ajout utilisateur: " + err.message);
    });
  });

  // Suppression étudiant / utilisateur
  document.getElementById('studentList').addEventListener('click', e => {
    if(e.target.classList.contains('btn-delete')) {
      if(!currentUser || !currentUser.canEdit) return alert("Droits insuffisants");
      const matricule = e.target.closest('tr').dataset.id;
      if(confirm(`Confirmer suppression de l'étudiant ${matricule} ?`)) {
        db.collection('students').doc(matricule).delete()
          .then(() => {
            addHistory(currentUser.matricule, `supprimé l'étudiant ${matricule}`);
          })
          .catch(err => alert("Erreur suppression: " + err.message));
      }
    }
  });
  document.getElementById('userList').addEventListener('click', e => {
    if(e.target.classList.contains('btn-delete')) {
      if(!currentUser || currentUser.right !== 'edit') return alert("Droits insuffisants");
      const matricule = e.target.closest('tr').dataset.matricule;
      if(confirm(`Confirmer suppression de l'utilisateur ${matricule} ?`)) {
        db.collection('users').doc(matricule).delete()
          .then(() => {
            addHistory(currentUser.matricule, `supprimé l'utilisateur ${matricule}`);
          })
          .catch(err => alert("Erreur suppression: " + err.message));
      }
    }
  });

  // Modification inline des données étudiant (nom, paiements)
  document.getElementById('studentList').addEventListener('input', e => {
    if(!currentUser || !currentUser.canEdit) return;
    const cell = e.target;
    const tr = cell.closest('tr');
    if(!tr) return;

    const matricule = tr.dataset.id;
    const fieldMap = {
      0: 'nom',
      2: 'p2025',
      3: 'p2026',
      4: 'p2027',
      5: 'p2028'
    };
    const cells = Array.from(tr.children);
    const colIndex = cells.indexOf(cell);
    const field = fieldMap[colIndex];
    if(!field) return;

    let val = cell.textContent.trim();
    if(['p2025','p2026','p2027','p2028'].includes(field)) {
      val = Number(val);
      if(isNaN(val) || val < 0) {
        cell.textContent = students.find(s => s.matricule === matricule)[field] || 0;
        return alert("Valeur de paiement invalide");
      }
    }
    // Mise à jour Firestore
    const updateObj = {};
    updateObj[field] = val;

    db.collection('students').doc(matricule).update(updateObj)
      .then(() => {
        addHistory(currentUser.matricule, `modifié ${field} de l'étudiant ${matricule} à "${val}"`);
      })
      .catch(err => {
        alert("Erreur mise à jour: " + err.message);
      });
  });

  // Navigation onglets
  function showTab(buttonId) {
    const tabs = ['btnGestion', 'btnParams', 'btnHistory'];
    tabs.forEach(id => {
      const btn = document.getElementById(id);
      const section = document.getElementById(id.replace('btn', '').toLowerCase() + 'Section');
      if(id === buttonId) {
        btn.classList.add('active');
        btn.setAttribute('aria-selected', 'true');
        btn.setAttribute('tabindex', '0');
        section.style.display = 'block';
        section.setAttribute('tabindex', '0');
      } else {
        btn.classList.remove('active');
        btn.setAttribute('aria-selected', 'false');
        btn.setAttribute('tabindex', '-1');
        section.style.display = 'none';
        section.setAttribute('tabindex', '-1');
      }
    });
  }
  document.getElementById('btnGestion').addEventListener('click', () => showTab('btnGestion'));
  document.getElementById('btnParams').addEventListener('click', () => showTab('btnParams'));
  document.getElementById('btnHistory').addEventListener('click', () => showTab('btnHistory'));

  // Historique ajout dans Firestore
  function addHistory(user, action) {
    db.collection('history').add({
      user,
      action,
      date: new Date()
    });
  }

  // Initialisation
  window.addEventListener('load', () => {
    // Vérifie si utilisateur déjà connecté en localstorage
    const saved = localStorage.getItem('currentUser');
    if(saved) {
      currentUser = JSON.parse(saved);
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('mainSection').style.display = 'block';
      showTab('btnGestion');
      loadStudentsRealtime();
      loadUsersRealtime();
      loadHistoryRealtime();
    }
  });
</script>

</body>
</html>
