<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestion Paiements Étudiants - Médecine</title>
<style>
  /* === Design stylé avec couleurs, arrondis, ombres === */
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0; background: #f4f9ff;
    font-family: 'Montserrat', sans-serif;
    color: #333;
    display: flex; justify-content: center; align-items: center;
    min-height: 100vh;
  }
  #app {
    background: white;
    width: 95vw;
    max-width: 1000px;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgb(0 123 255 / 0.2);
    overflow: hidden;
  }
  header {
    background: #007bff;
    color: white;
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: inset 0 -4px 8px rgb(0 0 0 / 0.1);
  }
  header svg {
    width: 36px; height: 36px;
    fill: #a6d8ff;
  }
  header h1 {
    font-weight: 600;
    font-size: 1.5rem;
    margin: 0;
  }
  #loginSection, #mainSection {
    padding: 1rem 2rem 2rem 2rem;
  }
  #loginSection {
    max-width: 400px;
    margin: 4rem auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgb(0 123 255 / 0.15);
    text-align: center;
  }
  #loginSection h1 {
    margin-bottom: 1.5rem;
    font-weight: 600;
    color: #007bff;
  }
  #loginForm input {
    display: block;
    width: 100%;
    margin-bottom: 1rem;
    padding: 0.8rem;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    transition: border-color 0.3s;
  }
  #loginForm input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 6px #007bffaa;
  }
  #loginForm button {
    width: 100%;
    background: #007bff;
    color: white;
    border: none;
    font-weight: 600;
    font-size: 1rem;
    padding: 0.8rem;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
  }
  #loginForm button:hover {
    background: #0056b3;
  }
  #loginError {
    color: #d9534f;
    margin-top: 0.5rem;
    display: none;
  }
  #logoutBtn {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 12px;
    padding: 0.5rem 1rem;
    font-weight: 600;
    cursor: pointer;
    float: right;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: background 0.3s;
  }
  #logoutBtn:hover {
    background: #b02a37;
  }
  #logoutBtn svg {
    width: 20px; height: 20px;
    fill: white;
  }
  nav {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  nav button {
    flex-grow: 1;
    padding: 0.8rem;
    background: #e7f0ff;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    color: #007bff;
    transition: background 0.3s, color 0.3s;
  }
  nav button.active,
  nav button:hover {
    background: #007bff;
    color: white;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
    font-size: 0.9rem;
  }
  th, td {
    text-align: center;
    padding: 0.6rem 0.8rem;
    border-bottom: 1px solid #ddd;
    vertical-align: middle;
  }
  thead {
    background: #007bff;
    color: white;
  }
  tbody tr:hover {
    background: #f1f9ff;
  }
  td[contenteditable="true"] {
    background: #e7f0ff;
    border-radius: 6px;
    cursor: text;
  }
  td[contenteditable="true"]:focus {
    outline: 2px solid #0056b3;
    background: #cce4ff;
  }
  .btn-delete {
    background: #dc3545;
    border: none;
    color: white;
    padding: 0.3rem 0.6rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s;
  }
  .btn-delete:hover {
    background: #a71d2a;
  }

  form.addForm {
    display: flex;
    gap: 0.6rem;
    flex-wrap: wrap;
    margin-bottom: 2rem;
  }
  form.addForm input,
  form.addForm select,
  form.addForm button {
    padding: 0.5rem 0.8rem;
    font-size: 0.9rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    flex: 1 1 120px;
  }
  form.addForm button {
    background: #28a745;
    border: none;
    color: white;
    font-weight: 600;
    cursor: pointer;
    flex: 1 1 120px;
    transition: background 0.3s;
  }
  form.addForm button:hover {
    background: #1e7e34;
  }

  /* Responsive */
  @media (max-width: 720px) {
    table, thead, tbody, th, td, tr {
      display: block;
    }
    thead tr {
      display: none;
    }
    tbody tr {
      margin-bottom: 1rem;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgb(0 123 255 / 0.1);
      background: white;
      padding: 1rem;
    }
    tbody tr td {
      display: flex;
      justify-content: space-between;
      padding: 0.6rem 1rem;
      border: none;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    tbody tr td:last-child {
      border-bottom: none;
    }
    tbody tr td::before {
      content: attr(data-label);
      font-weight: 600;
      color: #007bff;
    }
    form.addForm {
      flex-direction: column;
    }
  }

  /* Icône médicale dans header */
  header svg path {
    fill: #a6d8ff;
  }
</style>
</head>
<body>

<div id="app">
  <!-- LOGIN -->
  <section id="loginSection" role="dialog" aria-modal="true" aria-labelledby="loginTitle" aria-describedby="loginDesc">
    <h1 id="loginTitle">Connexion requise</h1>
    <p id="loginDesc">Veuillez entrer votre matricule et mot de passe pour accéder au site.</p>
    <form id="loginForm" aria-label="Formulaire de connexion">
      <input type="text" id="loginMatricule" placeholder="Matricule" required autocomplete="off" aria-required="true" aria-label="Matricule" />
      <input type="password" id="loginPassword" placeholder="Mot de passe" required autocomplete="off" aria-required="true" aria-label="Mot de passe" />
      <button type="submit" aria-label="Se connecter">Se connecter</button>
    </form>
    <p id="loginError" role="alert" aria-live="assertive" style="display:none; color:#d9534f; margin-top:0.5rem;">Matricule ou mot de passe incorrect.</p>
  </section>

  <!-- MAIN APP -->
  <section id="mainSection" style="display:none;" aria-live="polite">

    <button id="logoutBtn" title="Déconnexion" aria-label="Bouton déconnexion" style="margin-bottom:1rem;">
      <!-- Icône croix médicale -->
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" style="width:18px; height:18px; vertical-align:middle; margin-right:0.3rem;"><path d="M19 7v10a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2v-3H5v3a4 4 0 0 0 4 4h8a4 4 0 0 0 4-4V7z"/><path d="M16 12H7m5-5l-5 5 5 5" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Déconnexion
    </button>

    <header>
      <!-- Icône stéthoscope -->
      <svg aria-hidden="true" focusable="false" viewBox="0 0 64 64" width="36" height="36" style="flex-shrink:0; margin-right:1rem;">
        <path d="M53.2 15.8a3 3 0 0 0-2.7-1.7 3 3 0 0 0-2.5 1.2l-4.4 6.1a.5.5 0 0 1-.87-.33l-1-7.2a3 3 0 0 0-1.6-2.5l-10-5.8a2.97 2.97 0 0 0-3 .5 2.96 2.96 0 0 0-.92 2.4l.15 12.4-11.4 7.7a2.94 2.94 0 0 0-1 2.2 2.95 2.95 0 0 0 2.9 2.9 2.9 2.9 0 0 0 1.7-.52l11.4-7.7v17.6a5 5 0 1 0 4 0V23.4l4.4-6.1a.5.5 0 0 1 .87.33l1 7.2a3 3 0 0 0 1.6 2.5l10 5.8a3.02 3.02 0 0 0 4.1-3.3z" fill="#3a9ad9"/>
      </svg>
      <h1>Gestion paiements étudiants</h1>
    </header>

    <nav role="tablist" aria-label="Navigation principale" style="margin:1rem 0;">
      <button id="btnGestion" class="active" aria-controls="gestionSection" aria-selected="true" role="tab" tabindex="0">Gestion</button>
      <button id="btnParams" style="display:none;" aria-controls="paramsSection" aria-selected="false" role="tab" tabindex="-1">Paramètres</button>
      <button id="btnHistory" style="display:none;" aria-controls="historySection" aria-selected="false" role="tab" tabindex="-1">Historique</button>
    </nav>

    <section id="gestionSection" role="tabpanel" tabindex="0" aria-label="Gestion des étudiants">
      <table aria-label="Liste des étudiants">
        <thead>
          <tr>
            <th>Nom et prénom</th>
            <th>Matricule</th>
            <th>2025 (Ar)</th>
            <th>2026 (Ar)</th>
            <th>2027 (Ar)</th>
            <th>2028 (Ar)</th>
            <th>Total (Ar)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="studentList"></tbody>
      </table>

      <form id="addStudentForm" class="addForm" aria-label="Formulaire d'ajout d'étudiant">
        <input type="text" id="addNom" placeholder="Nom et prénom" required autocomplete="off" aria-required="true" aria-label="Nom et prénom" />
        <input type="text" id="addMatricule" placeholder="Matricule" required autocomplete="off" aria-required="true" aria-label="Matricule" />
        <input type="number" id="add2025" placeholder="2025" min="0" value="0" required aria-label="Paiement 2025" />
        <input type="number" id="add2026" placeholder="2026" min="0" value="0" required aria-label="Paiement 2026" />
        <input type="number" id="add2027" placeholder="2027" min="0" value="0" required aria-label="Paiement 2027" />
        <input type="number" id="add2028" placeholder="2028" min="0" value="0" required aria-label="Paiement 2028" />
        <button type="submit" id="addStudentBtn">Ajouter</button>
      </form>
    </section>

    <section id="paramsSection" role="tabpanel" tabindex="0" style="display:none;" aria-label="Paramètres">
      <h2>Gestion des utilisateurs</h2>
      <table aria-label="Liste des utilisateurs">
        <thead>
          <tr>
            <th>Matricule</th>
            <th>Mot de passe</th>
            <th>Droits</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="userList"></tbody>
      </table>

      <form id="addUserForm" class="addForm" aria-label="Formulaire d'ajout d'utilisateur">
        <input type="text" id="addUserMatricule" placeholder="Matricule" required autocomplete="off" aria-required="true" aria-label="Matricule utilisateur" />
        <input type="password" id="addUserPassword" placeholder="Mot de passe" required autocomplete="off" aria-required="true" aria-label="Mot de passe utilisateur" />
        <select id="addUserRight" required aria-label="Droits utilisateur">
          <option value="" disabled selected>Choisir droits</option>
          <option value="edit">Peut modifier</option>
          <option value="read">Lecture seule</option>
        </select>
        <button type="submit" id="addUserBtn">Ajouter utilisateur</button>
      </form>
    </section>

    <section id="historySection" role="tabpanel" tabindex="0" style="display:none;" aria-label="Historique">
      <h2>Historique des modifications</h2>
      <ul id="historyList" style="max-height:300px;overflow:auto;padding-left:1rem;"></ul>
    </section>

  </section>
</div>

<script>
(() => {
  const tzOffsetMadagascar = 3 * 60; // +3h en minutes

  const loginSection = document.getElementById('loginSection');
  const loginForm = document.getElementById('loginForm');
  const loginError = document.getElementById('loginError');
  const mainSection = document.getElementById('mainSection');
  const logoutBtn = document.getElementById('logoutBtn');
  const menuGestionBtn = document.getElementById('btnGestion');
  const menuParamsBtn = document.getElementById('btnParams');
  const menuHistoryBtn = document.getElementById('btnHistory');
  const gestionSection = document.getElementById('gestionSection');
  const paramsSection = document.getElementById('paramsSection');
  const historySection = document.getElementById('historySection');
  const studentListTbody = document.getElementById('studentList');
  const addStudentForm = document.getElementById('addStudentForm');
  const userListTbody = document.getElementById('userList');
  const addUserForm = document.getElementById('addUserForm');
  const historyList = document.getElementById('historyList');

  let students = JSON.parse(localStorage.getItem('students') || '[]');
  let users = JSON.parse(localStorage.getItem('users') || '{}');
  let history = JSON.parse(localStorage.getItem('history') || '[]');
  let currentUser = null;

  // Initialize default users if none
  if(Object.keys(users).length === 0){
    users = {
      "E001": {password: "pass2025", canEdit: true},
      "E002": {password: "pass2026", canEdit: false}
    };
    localStorage.setItem('users', JSON.stringify(users));
  }

  function formatMadagascarDate(d){
    const utc = d.getTime() + (d.getTimezoneOffset() * 60000);
    const madagascarTime = new Date(utc + tzOffsetMadagascar * 60000);
    return madagascarTime.toLocaleString('fr-FR', {dateStyle:'short', timeStyle:'short'});
  }

  // Save/load
  function saveStudents(data){
    localStorage.setItem('students', JSON.stringify(data));
  }
  function saveUsers(data){
    localStorage.setItem('users', JSON.stringify(data));
  }
  function saveHistory(data){
    localStorage.setItem('history', JSON.stringify(data));
  }

  // Render
  function renderStudents(){
    // Trier alphabétiquement par nom
    students.sort((a,b) => a.nom.localeCompare(b.nom));
    studentListTbody.innerHTML = '';
    students.forEach((s, idx) => {
      const total = (Number(s.p2025)||0) + (Number(s.p2026)||0) + (Number(s.p2027)||0) + (Number(s.p2028)||0);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td ${currentUser.canEdit ? 'contenteditable="true" aria-label="Nom et prénom de '+s.nom+'"': ''} data-label="Nom et prénom">${s.nom}</td>
        <td data-label="Matricule">${s.matricule}</td>
        <td ${currentUser.canEdit ? 'contenteditable="true" aria-label="Paiement 2025 de '+s.nom+'"' : ''} data-label="2025 (Ar)">${s.p2025 || 0}</td>
        <td ${currentUser.canEdit ? 'contenteditable="true" aria-label="Paiement 2026 de '+s.nom+'"' : ''} data-label="2026 (Ar)">${s.p2026 || 0}</td>
        <td ${currentUser.canEdit ? 'contenteditable="true" aria-label="Paiement 2027 de '+s.nom+'"' : ''} data-label="2027 (Ar)">${s.p2027 || 0}</td>
        <td ${currentUser.canEdit ? 'contenteditable="true" aria-label="Paiement 2028 de '+s.nom+'"' : ''} data-label="2028 (Ar)">${s.p2028 || 0}</td>
        <td data-label="Total (Ar)"><strong>${total}</strong></td>
        <td data-label="Action">${currentUser.canEdit ? `<button class="btn-delete" aria-label="Supprimer ${s.nom}">Supprimer</button>` : ''}</td>
      `;
      studentListTbody.appendChild(tr);

      if(currentUser.canEdit){
        // Ecoute pour modification inline
        const cells = tr.querySelectorAll('td[contenteditable="true"]');
        cells.forEach((cell, i) => {
          cell.addEventListener('blur', () => {
            const val = cell.textContent.trim();
            if(i === 0) {
              // nom modif
              if(val === ''){
                alert('Le nom ne peut pas être vide.');
                cell.textContent = s.nom;
                return;
              }
              s.nom = val;
            } else {
              // paiement modif (cols 1 à 4)
              let n = Number(val);
              if(isNaN(n) || n < 0){
                alert('Le paiement doit être un nombre positif.');
                cell.textContent = s['p2025'] || 0;
                renderStudents();
                return;
              }
              switch(i){
                case 1: s.p2025 = n; break;
                case 2: s.p2026 = n; break;
                case 3: s.p2027 = n; break;
                case 4: s.p2028 = n; break;
              }
            }
            saveStudents(students);
            addHistory(`Modification étudiant ${s.nom} (${s.matricule})`);
            renderStudents();
          });
        });

        // Supprimer
        const btnDelete = tr.querySelector('.btn-delete');
        btnDelete.addEventListener('click', () => {
          if(confirm(`Supprimer ${s.nom} (${s.matricule}) ?`)){
            students.splice(idx,1);
            saveStudents(students);
            addHistory(`Suppression étudiant ${s.nom} (${s.matricule})`);
            renderStudents();
          }
        });
      }
    });
  }

  function renderUsers(){
    userListTbody.innerHTML = '';
    Object.entries(users).forEach(([mat, u]) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${mat}</td>
        <td>${'*'.repeat(u.password.length)}</td>
        <td>${u.canEdit ? 'Modification' : 'Lecture seule'}</td>
        <td>${currentUser.canEdit ? `<button class="btn-delete" aria-label="Supprimer utilisateur ${mat}">Supprimer</button>` : ''}</td>
      `;
      userListTbody.appendChild(tr);

      if(currentUser.canEdit){
        const btnDel = tr.querySelector('.btn-delete');
        btnDel.addEventListener('click', () => {
          if(confirm(`Supprimer utilisateur ${mat} ?`)){
            delete users[mat];
            saveUsers(users);
            addHistory(`Suppression utilisateur ${mat}`);
            renderUsers();
          }
        });
      }
    });
  }

  function renderHistory(){
    historyList.innerHTML = '';
    if(history.length === 0){
      historyList.innerHTML = '<li>Aucune action enregistrée.</li>';
      return;
    }
    history.slice().reverse().forEach(h => {
      const li = document.createElement('li');
      li.textContent = `[${h.date}] ${h.action}`;
      historyList.appendChild(li);
    });
  }

  // Ajout historique
  function addHistory(action){
    const now = new Date();
    const date = formatMadagascarDate(now);
    history.push({date, action});
    saveHistory(history);
    renderHistory();
  }

  // Gestion des sections
  function switchSection(section){
    if(section === 'gestion'){
      gestionSection.style.display = 'block';
      paramsSection.style.display = 'none';
      historySection.style.display = 'none';
      menuGestionBtn.classList.add('active');
      menuParamsBtn.classList.remove('active');
      menuHistoryBtn.classList.remove('active');
      menuGestionBtn.setAttribute('aria-selected', 'true');
      menuParamsBtn.setAttribute('aria-selected', 'false');
      menuHistoryBtn.setAttribute('aria-selected', 'false');
      menuGestionBtn.tabIndex = 0;
      menuParamsBtn.tabIndex = -1;
      menuHistoryBtn.tabIndex = -1;
    } else if(section === 'params'){
      gestionSection.style.display = 'none';
      paramsSection.style.display = 'block';
      historySection.style.display = 'none';
      menuGestionBtn.classList.remove('active');
      menuParamsBtn.classList.add('active');
      menuHistoryBtn.classList.remove('active');
      menuGestionBtn.setAttribute('aria-selected', 'false');
      menuParamsBtn.setAttribute('aria-selected', 'true');
      menuHistoryBtn.setAttribute('aria-selected', 'false');
      menuGestionBtn.tabIndex = -1;
      menuParamsBtn.tabIndex = 0;
      menuHistoryBtn.tabIndex = -1;
    } else {
      gestionSection.style.display = 'none';
      paramsSection.style.display = 'none';
      historySection.style.display = 'block';
      menuGestionBtn.classList.remove('active');
      menuParamsBtn.classList.remove('active');
      menuHistoryBtn.classList.add('active');
      menuGestionBtn.setAttribute('aria-selected', 'false');
      menuParamsBtn.setAttribute('aria-selected', 'false');
      menuHistoryBtn.setAttribute('aria-selected', 'true');
      menuGestionBtn.tabIndex = -1;
      menuParamsBtn.tabIndex = -1;
      menuHistoryBtn.tabIndex = 0;
    }
  }

  // LOGIN FORM
  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    const mat = loginForm.loginMatricule.value.trim();
    const pwd = loginForm.loginPassword.value;

    if(users[mat] && users[mat].password === pwd){
      currentUser = {matricule: mat, canEdit: users[mat].canEdit};
      loginError.style.display = 'none';
      loginSection.style.display = 'none';
      mainSection.style.display = 'block';

      // Afficher onglets selon droits
      if(currentUser.canEdit){
        menuParamsBtn.style.display = 'inline-block';
        menuHistoryBtn.style.display = 'inline-block';
      } else {
        menuParamsBtn.style.display = 'none';
        menuHistoryBtn.style.display = 'none';
      }
      switchSection('gestion');
      renderStudents();
      renderUsers();
      renderHistory();

      // Afficher ou masquer formulaire ajout étudiant selon droits
      addStudentForm.style.display = currentUser.canEdit ? 'flex' : 'none';
      addUserForm.style.display = currentUser.canEdit ? 'flex' : 'none';
    } else {
      loginError.style.display = 'block';
    }
  });

  // Logout
  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    loginSection.style.display = 'block';
    mainSection.style.display = 'none';
    loginForm.reset();
    loginError.style.display = 'none';
  });

  // Navigation
  menuGestionBtn.addEventListener('click', () => switchSection('gestion'));
  menuParamsBtn.addEventListener('click', () => switchSection('params'));
  menuHistoryBtn.addEventListener('click', () => switchSection('history'));

  // Ajout étudiant
  addStudentForm.addEventListener('submit', e => {
    e.preventDefault();
    if(!currentUser.canEdit) return;

    const nom = addStudentForm.addNom.value.trim();
    const matricule = addStudentForm.addMatricule.value.trim();
    const p2025 = Number(addStudentForm.add2025.value);
    const p2026 = Number(addStudentForm.add2026.value);
    const p2027 = Number(addStudentForm.add2027.value);
    const p2028 = Number(addStudentForm.add2028.value);

    if(students.find(s => s.matricule === matricule)){
      alert('Matricule déjà existant.');
      return;
    }

    students.push({nom, matricule, p2025, p2026, p2027, p2028});
    saveStudents(students);
    addHistory(`Ajout étudiant ${nom} (${matricule})`);
    renderStudents();
    addStudentForm.reset();
  });

  // Ajout utilisateur
  addUserForm.addEventListener('submit', e => {
    e.preventDefault();
    if(!currentUser.canEdit) return;

    const mat = addUserForm.addUserMatricule.value.trim();
    const pwd = addUserForm.addUserPassword.value;
    const right = addUserForm.addUserRight.value;

    if(users[mat]){
      alert('Matricule utilisateur déjà existant.');
      return;
    }

    users[mat] = {password: pwd, canEdit: right === 'edit'};
    saveUsers(users);
    addHistory(`Ajout utilisateur ${mat} (${right})`);
    renderUsers();
    addUserForm.reset();
  });
})();
</script>

</body>
</html>
