<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestion Paiements Étudiants - Médecine</title>
<style>
  /* (Le style complet est le même que dans la première partie que je t'ai envoyée) */
  /* Pour éviter la longueur, je te laisse reprendre celui que je t'ai envoyé juste avant */
</style>
</head>
<body>

<div id="app">

  <!-- LOGIN -->
  <section id="loginSection">
    <h1>Connexion requise</h1>
    <form id="loginForm" aria-label="Formulaire de connexion">
      <input type="text" id="loginMatricule" placeholder="Matricule" required autocomplete="off" aria-required="true" aria-label="Matricule" />
      <input type="password" id="loginPassword" placeholder="Mot de passe" required autocomplete="off" aria-required="true" aria-label="Mot de passe" />
      <button type="submit">Se connecter</button>
    </form>
    <p id="loginError" role="alert" aria-live="assertive">Matricule ou mot de passe incorrect.</p>
  </section>

  <!-- APP -->
  <section id="mainSection" style="display:none;" aria-live="polite">

    <button id="logoutBtn" title="Déconnexion" aria-label="Bouton déconnexion">
      <!-- Icône croix médicale -->
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M19 7v10a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2v-3H5v3a4 4 0 0 0 4 4h8a4 4 0 0 0 4-4V7z"/><path d="M16 12H7m5-5l-5 5 5 5" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Déconnexion
    </button>

    <header>
      <!-- Icône stéthoscope -->
      <svg aria-hidden="true" focusable="false" viewBox="0 0 64 64" >
        <path d="M53.2 15.8a3 3 0 0 0-2.7-1.7 3 3 0 0 0-2.5 1.2l-4.4 6.1a.5.5 0 0 1-.87-.33l-1-7.2a3 3 0 0 0-1.6-2.5l-10-5.8a2.97 2.97 0 0 0-3 .5 2.96 2.96 0 0 0-.92 2.4l.15 12.4-11.4 7.7a2.94 2.94 0 0 0-1 2.2 2.95 2.95 0 0 0 2.9 2.9 2.9 2.9 0 0 0 1.7-.52l11.4-7.7v17.6a5 5 0 1 0 4 0V23.4l4.4-6.1a.5.5 0 0 1 .87.33l1 7.2a3 3 0 0 0 1.6 2.5l10 5.8a3.02 3.02 0 0 0 4.1-3.3z" fill="#3a9ad9"/>
      </svg>
      <h1>Gestion paiements étudiants</h1>
    </header>

    <nav id="menuNav" aria-label="Navigation principale">
      <button id="btnGestion" class="active" aria-controls="gestionSection" aria-selected="true" role="tab">Gestion</button>
      <button id="btnParams" style="display:none;" aria-controls="paramsSection" aria-selected="false" role="tab">Paramètres</button>
      <button id="btnHistory" style="display:none;" aria-controls="historySection" aria-selected="false" role="tab">Historique</button>
    </nav>

    <!-- Gestion étudiants -->
    <section id="gestionSection" role="tabpanel" tabindex="0">
      <table aria-label="Liste des étudiants">
        <thead>
          <tr>
            <th>Nom et prénom</th>
            <th>Matricule</th>
            <th>2025 (Ar)</th>
            <th>2026 (Ar)</th>
            <th>2027 (Ar)</th>
            <th>2028 (Ar)</th>
            <th>Total (Ar)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="studentList"></tbody>
      </table>

      <form id="addStudentForm" class="addForm" aria-label="Formulaire ajout étudiant">
        <input type="text" id="addNom" placeholder="Nom et prénom" required autocomplete="off" aria-required="true" aria-label="Nom et prénom" />
        <input type="text" id="addMatricule" placeholder="Matricule" required autocomplete="off" aria-required="true" aria-label="Matricule" />
        <input type="number" id="add2025" placeholder="2025" min="0" value="0" required aria-label="Paiement 2025" />
        <input type="number" id="add2026" placeholder="2026" min="0" value="0" required aria-label="Paiement 2026" />
        <input type="number" id="add2027" placeholder="2027" min="0" value="0" required aria-label="Paiement 2027" />
        <input type="number" id="add2028" placeholder="2028" min="0" value="0" required aria-label="Paiement 2028" />
        <button type="submit" id="addStudentBtn">Ajouter</button>
      </form>
    </section>

    <!-- Paramètres utilisateurs -->
    <section id="paramsSection" style="display:none;" role="tabpanel" tabindex="0">
      <h2>Gestion des utilisateurs</h2>
      <table aria-label="Liste des utilisateurs">
        <thead>
          <tr>
            <th>Matricule</th>
            <th>Mot de passe</th>
            <th>Droits</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="userList"></tbody>
      </table>

      <form id="addUserForm" class="addForm" aria-label="Formulaire ajout utilisateur">
        <input type="text" id="addUserMatricule" placeholder="Matricule" required autocomplete="off" aria-required="true" aria-label="Matricule utilisateur" />
        <input type="password" id="addUserPassword" placeholder="Mot de passe" required autocomplete="off" aria-required="true" aria-label="Mot de passe utilisateur" />
        <select id="addUserRight" required aria-label="Droits utilisateur">
          <option value="" disabled selected>Choisir droits</option>
          <option value="edit">Peut modifier</option>
          <option value="read">Lecture seule</option>
        </select>
        <button type="submit" id="addUserBtn">Ajouter utilisateur</button>
      </form>
    </section>

    <!-- Historique -->
    <section id="historySection" style="display:none;" role="tabpanel" tabindex="0">
      <h2>Historique des modifications</h2>
      <ul id="historyList" style="max-height:300px;overflow:auto;padding-left:1rem;"></ul>
    </section>

  </section>

</div>

<script>
(() => {
  const tzOffsetMadagascar = 3 * 60; // +3h en minutes

  // Elements
  const loginSection = document.getElementById('loginSection');
  const loginForm = document.getElementById('loginForm');
  const loginError = document.getElementById('loginError');
  const mainSection = document.getElementById('mainSection');
  const logoutBtn = document.getElementById('logoutBtn');
  const menuGestionBtn = document.getElementById('btnGestion');
  const menuParamsBtn = document.getElementById('btnParams');
  const menuHistoryBtn = document.getElementById('btnHistory');
  const gestionSection = document.getElementById('gestionSection');
  const paramsSection = document.getElementById('paramsSection');
  const historySection = document.getElementById('historySection');
  const studentListTbody = document.getElementById('studentList');
  const addStudentForm = document.getElementById('addStudentForm');
  const userListTbody = document.getElementById('userList');
  const addUserForm = document.getElementById('addUserForm');
  const historyList = document.getElementById('historyList');

  let students = JSON.parse(localStorage.getItem('students') || '[]');
  let users = JSON.parse(localStorage.getItem('users') || '{}');
  let history = JSON.parse(localStorage.getItem('history') || '[]');
  let currentUser = null;

  // Init default users if none
  if (Object.keys(users).length === 0) {
    users = {
      "E001": {password: "pass2025", canEdit: true},
      "E002": {password: "pass2026", canEdit: false}
    };
    localStorage.setItem('users', JSON.stringify(users));
  }

  // Helper: format date Madagascar
  function formatMadagascarDate(d) {
    // Convert local time to Madagascar timezone (+3h)
    // We'll build string like: JJ/MM/YYYY HH:mm:ss
    const utc = d.getTime() + (d.getTimezoneOffset() * 60000);
    const madagascarTime = new Date(utc + tzOffsetMadagascar * 60000);

    const pad = n => (n < 10 ? '0' + n : n);
    return `${pad(madagascarTime.getDate())}/${pad(madagascarTime.getMonth()+1)}/${madagascarTime.getFullYear()} `+
           `${pad(madagascarTime.getHours())}:${pad(madagascarTime.getMinutes())}:${pad(madagascarTime.getSeconds())}`;
  }

  // Save all to localStorage
  function saveStudents(data) {
    localStorage.setItem('students', JSON.stringify(data));
  }
  function saveUsers(data) {
    localStorage.setItem('users', JSON.stringify(data));
  }
  function saveHistory(data) {
    localStorage.setItem('history', JSON.stringify(data));
  }

  // Render students list with inline editable cells
  function renderStudents() {
    // Sort alphabetically by name
    students.sort((a,b) => a.nom.localeCompare(b.nom, 'fr', {sensitivity:'base'}));

    studentListTbody.innerHTML = '';
    for (const s of students) {
      const tr = document.createElement('tr');
      // Nom et prénom
      const tdNom = document.createElement('td');
      tdNom.textContent = s.nom;
      tdNom.contentEditable = currentUser?.canEdit;
      tdNom.setAttribute('aria-label', 'Nom et prénom');
      tdNom.spellcheck = false;
      tdNom.addEventListener('blur', () => updateStudentField(s.matricule, 'nom', tdNom.textContent.trim()));

      // Matricule (non modifiable)
      const tdMat = document.createElement('td');
      tdMat.textContent = s.matricule;
      tdMat.setAttribute('aria-label', 'Matricule');

      // Paiements 2025 à 2028 (editable)
      const years = ['p2025', 'p2026', 'p2027', 'p2028'];
      const yearCols = years.map(y => {
        const td = document.createElement('td');
        td.textContent = s[y];
        td.contentEditable = currentUser?.canEdit;
        td.setAttribute('aria-label', `Paiement ${y.slice(1)}`);
        td.spellcheck = false;
        td.addEventListener('blur', () => {
          const val = parseInt(td.textContent.trim());
          if (isNaN(val) || val < 0) {
            alert('Le paiement doit être un nombre positif ou zéro.');
            td.textContent = s[y];
            return;
          }
          updateStudentField(s.matricule, y, val);
        });
        return td;
      });

      // Total
      const total = years.reduce((acc,y) => acc + (parseInt(s[y])||0), 0);
      const tdTotal = document.createElement('td');
      tdTotal.textContent = total;
      tdTotal.setAttribute('aria-label', 'Total des paiements');

      // Action (supprimer)
      const tdAction = document.createElement('td');
      if(currentUser?.canEdit){
        const btnDel = document.createElement('button');
        btnDel.textContent = 'Supprimer';
        btnDel.className = 'btn-delete';
        btnDel.addEventListener('click', () => {
          if(confirm(`Supprimer ${s.nom} (${s.matricule}) ?`)){
            students = students.filter(st => st.matricule !== s.matricule);
            saveStudents(students);
            addHistory(`Suppression de l'étudiant ${s.nom} (${s.matricule})`);
            renderStudents();
          }
        });
        tdAction.appendChild(btnDel);
      } else {
        tdAction.textContent = '-';
      }

      tr.appendChild(tdNom);
      tr.appendChild(tdMat);
      yearCols.forEach(td => tr.appendChild(td));
      tr.appendChild(tdTotal);
      tr.appendChild(tdAction);

      studentListTbody.appendChild(tr);
    }
  }

  // Update student field and save + history
  function updateStudentField(matricule, field, value){
    const student = students.find(s => s.matricule === matricule);
    if(!student) return;
    const oldValue = student[field];
    if(oldValue === value) return;

    student[field] = value;
    saveStudents(students);
    addHistory(`Modification ${field} de ${student.nom} (${matricule}) : "${oldValue}" → "${value}"`);
    renderStudents();
  }

  // Render users list
  function renderUsers(){
    userListTbody.innerHTML = '';
    for(const mat in users){
      const u = users[mat];
      const tr = document.createElement('tr');

      const tdMat = document.createElement('td');
      tdMat.textContent = mat;

      const tdPwd = document.createElement('td');
      tdPwd.textContent = '*'.repeat(u.password.length);

      const tdRight = document.createElement('td');
      tdRight.textContent = u.canEdit ? 'Modification' : 'Lecture seule';

      const tdAction = document.createElement('td');
      if(currentUser?.canEdit && mat !== currentUser.matricule){
        const btnDel = document.createElement('button');
        btnDel.textContent = 'Supprimer';
        btnDel.className = 'btn-delete';
        btnDel.addEventListener('click', () => {
          if(confirm(`Supprimer l'utilisateur ${mat} ?`)){
            delete users[mat];
            saveUsers(users);
            addHistory(`Suppression utilisateur ${mat}`);
            renderUsers();
          }
        });
        tdAction.appendChild(btnDel);
      } else {
        tdAction.textContent = '-';
      }

      tr.appendChild(tdMat);
      tr.appendChild(tdPwd);
      tr.appendChild(tdRight);
      tr.appendChild(tdAction);
      userListTbody.appendChild(tr);
    }
  }

  // Add history entry
  function addHistory(action) {
    const now = new Date();
    const dateStr = formatMadagascarDate(now);
    history.unshift(`${dateStr} - ${currentUser.matricule}: ${action}`);
    if(history.length > 100) history.pop(); // max 100 entrées
    saveHistory(history);
    renderHistory();
  }

  // Render history list
  function renderHistory(){
    historyList.innerHTML = '';
    for(const h of history){
      const li = document.createElement('li');
      li.textContent = h;
      historyList.appendChild(li);
    }
  }

  // Switch visible section
  function switchSection(section) {
    gestionSection.style.display = 'none';
    paramsSection.style.display = 'none';
    historySection.style.display = 'none';

    menuGestionBtn.classList.remove('active');
    menuParamsBtn.classList.remove('active');
    menuHistoryBtn.classList.remove('active');

    if(section === 'gestion'){
      gestionSection.style.display = 'block';
      menuGestionBtn.classList.add('active');
    } else if(section === 'params'){
      paramsSection.style.display = 'block';
      menuParamsBtn.classList.add('active');
    } else if(section === 'history'){
      historySection.style.display = 'block';
      menuHistoryBtn.classList.add('active');
    }
  }

  // Login form submit
  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    const mat = loginForm.loginMatricule.value.trim();
    const pwd = loginForm.loginPassword.value;

    if(users[mat] && users[mat].password === pwd){
      currentUser = {matricule: mat, canEdit: users[mat].canEdit};
      loginSection.style.display = 'none';
      mainSection.style.display = 'block';
      loginError.style.display = 'none';

      menuParamsBtn.style.display = currentUser.canEdit ? 'inline-block' : 'none';
      menuHistoryBtn.style.display = 'inline-block';

      addStudentForm.style.display = currentUser.canEdit ? 'flex' : 'none';

      switchSection('gestion');
      renderStudents();
      renderUsers();
      renderHistory();

    } else {
      loginError.style.display = 'block';
    }
  });

  // Add student
  addStudentForm.addEventListener('submit', e => {
    e.preventDefault();
    if(!currentUser.canEdit) return;

    const nom = addStudentForm.addNom.value.trim();
    const matricule = addStudentForm.addMatricule.value.trim();
    const p2025 = Number(addStudentForm.add2025.value);
    const p2026 = Number(addStudentForm.add2026.value);
    const p2027 = Number(addStudentForm.add2027.value);
    const p2028 = Number(addStudentForm.add2028.value);

    if(students.find(s => s.matricule === matricule)){
      alert('Matricule déjà existant.');
      return;
    }

    students.push({nom, matricule, p2025, p2026, p2027, p2028});
    saveStudents(students);
    addHistory(`Ajout étudiant ${nom} (${matricule})`);
    renderStudents();
    addStudentForm.reset();
  });

  // Add user
  addUserForm.addEventListener('submit', e => {
    e.preventDefault();
    if(!currentUser.canEdit) return;

    const mat = addUserForm.addUserMatricule.value.trim();
    const pwd = addUserForm.addUserPassword.value;
    const right = addUserForm.addUserRight.value;

    if(users[mat]){
      alert('Matricule utilisateur déjà existant.');
      return;
    }

    users[mat] = {password: pwd, canEdit: right === 'edit'};
    saveUsers(users);
    addHistory(`Ajout utilisateur ${mat} (${right})`);
    renderUsers();
    addUserForm.reset();
  });

  // Logout
  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    loginSection.style.display = 'block';
    mainSection.style.display = 'none';
    loginForm.reset();
  });

  // Navigation
  menuGestionBtn.addEventListener('click', () => switchSection('gestion'));
  menuParamsBtn.addEventListener('click', () => switchSection('params'));
  menuHistoryBtn.addEventListener('click', () => switchSection('history'));

})();
</script>

</body>
</html>
