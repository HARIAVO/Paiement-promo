<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestion Paiements Étudiants - Médecine</title>
<style>
  /* Ton style d’origine ici, inchangé, je le raccourcis pour l’exemple */
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');
  * { box-sizing: border-box; }
  body {
    margin:0; padding:0; background:#f4f9ff;
    font-family: 'Montserrat', sans-serif;
    color:#333;
    display:flex; justify-content:center; align-items:center;
    min-height:100vh;
  }
  #app {
    background:white;
    width:95vw;
    max-width:1000px;
    border-radius:15px;
    box-shadow:0 8px 20px rgb(0 123 255 / 0.2);
    overflow:hidden;
  }
  /* (Le reste de ton CSS d’origine, inchangé) */
</style>
</head>
<body>

<div id="app">
  <!-- Login Section -->
  <section id="loginSection" role="dialog" aria-modal="true" aria-labelledby="loginTitle" aria-describedby="loginDesc">
    <h1 id="loginTitle">Connexion requise</h1>
    <p id="loginDesc">Veuillez entrer votre matricule et mot de passe pour accéder au site.</p>
    <form id="loginForm" aria-label="Formulaire de connexion">
      <input type="text" id="loginMatricule" placeholder="Matricule" required autocomplete="off" aria-required="true" aria-label="Matricule" />
      <input type="password" id="loginPassword" placeholder="Mot de passe" required autocomplete="off" aria-required="true" aria-label="Mot de passe" />
      <button type="submit" aria-label="Se connecter">Se connecter</button>
    </form>
    <p id="loginError" role="alert" aria-live="assertive" style="display:none; color:#d9534f; margin-top:0.5rem;">Matricule ou mot de passe incorrect.</p>
  </section>

  <!-- Main Section -->
  <section id="mainSection" style="display:none;" aria-live="polite">

    <button id="logoutBtn" title="Déconnexion" aria-label="Bouton déconnexion" style="margin-bottom:1rem;">
      Déconnexion
    </button>

    <header>
      <h1>Gestion paiements étudiants</h1>
    </header>

    <nav role="tablist" aria-label="Navigation principale" style="margin:1rem 0;">
      <button id="btnGestion" class="active" aria-controls="gestionSection" aria-selected="true" role="tab" tabindex="0">Gestion</button>
      <button id="btnParams" style="display:none;" aria-controls="paramsSection" aria-selected="false" role="tab" tabindex="-1">Paramètres</button>
      <button id="btnHistory" style="display:none;" aria-controls="historySection" aria-selected="false" role="tab" tabindex="-1">Historique</button>
    </nav>

    <section id="gestionSection" role="tabpanel" tabindex="0" aria-label="Gestion des étudiants">
      <table aria-label="Liste des étudiants">
        <thead>
          <tr>
            <th>Nom et prénom</th>
            <th>Matricule</th>
            <th>2025 (Ar)</th>
            <th>2026 (Ar)</th>
            <th>2027 (Ar)</th>
            <th>2028 (Ar)</th>
            <th>Total (Ar)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="studentList"></tbody>
      </table>

      <form id="addStudentForm" class="addForm" aria-label="Formulaire d'ajout d'étudiant">
        <input type="text" id="addNom" placeholder="Nom et prénom" required autocomplete="off" aria-required="true" aria-label="Nom et prénom" />
        <input type="text" id="addMatricule" placeholder="Matricule" required autocomplete="off" aria-required="true" aria-label="Matricule" />
        <input type="number" id="add2025" placeholder="2025" min="0" value="0" required aria-label="Paiement 2025" />
        <input type="number" id="add2026" placeholder="2026" min="0" value="0" required aria-label="Paiement 2026" />
        <input type="number" id="add2027" placeholder="2027" min="0" value="0" required aria-label="Paiement 2027" />
        <input type="number" id="add2028" placeholder="2028" min="0" value="0" required aria-label="Paiement 2028" />
        <button type="submit" id="addStudentBtn">Ajouter</button>
      </form>
    </section>

    <section id="paramsSection" role="tabpanel" tabindex="0" style="display:none;" aria-label="Paramètres">
      <h2>Gestion des utilisateurs</h2>
      <table aria-label="Liste des utilisateurs">
        <thead>
          <tr>
            <th>Matricule</th>
            <th>Mot de passe</th>
            <th>Droits</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="userList"></tbody>
      </table>

      <form id="addUserForm" class="addForm" aria-label="Formulaire d'ajout d'utilisateur">
        <input type="text" id="addUserMatricule" placeholder="Matricule" required autocomplete="off" aria-required="true" aria-label="Matricule utilisateur" />
        <input type="password" id="addUserPassword" placeholder="Mot de passe" required autocomplete="off" aria-required="true" aria-label="Mot de passe utilisateur" />
        <select id="addUserRight" required aria-label="Droits utilisateur">
          <option value="" disabled selected>Choisir droits</option>
          <option value="edit">Peut modifier</option>
          <option value="read">Lecture seule</option>
        </select>
        <button type="submit" id="addUserBtn">Ajouter utilisateur</button>
      </form>
    </section>

    <section id="historySection" role="tabpanel" tabindex="0" style="display:none;" aria-label="Historique">
      <h2>Historique des modifications</h2>
      <ul id="historyList" style="max-height:300px;overflow:auto;padding-left:1rem;"></ul>
    </section>

  </section>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
(() => {
  const tzOffsetMadagascar = 3 * 60; // +3h en minutes

  const loginSection = document.getElementById('loginSection');
  const loginForm = document.getElementById('loginForm');
  const loginError = document.getElementById('loginError');
  const mainSection = document.getElementById('mainSection');
  const logoutBtn = document.getElementById('logoutBtn');
  const menuGestionBtn = document.getElementById('btnGestion');
  const menuParamsBtn = document.getElementById('btnParams');
  const menuHistoryBtn = document.getElementById('btnHistory');
  const gestionSection = document.getElementById('gestionSection');
  const paramsSection = document.getElementById('paramsSection');
  const historySection = document.getElementById('historySection');
  const studentListTbody = document.getElementById('studentList');
  const addStudentForm = document.getElementById('addStudentForm');
  const userListTbody = document.getElementById('userList');
  const addUserForm = document.getElementById('addUserForm');
  const historyList = document.getElementById('historyList');

  // Firebase config & init
  const firebaseConfig = {
    apiKey: "AIzaSyDW8_PXm8MpM-NSANtFqIL4egHN9DjtJUo",
    authDomain: "gestion-paiements-medecine.firebaseapp.com",
    databaseURL: "https://gestion-paiements-medecine-default-rtdb.firebaseio.com",
    projectId: "gestion-paiements-medecine",
    storageBucket: "gestion-paiements-medecine.firebasestorage.app",
    messagingSenderId: "973526886140",
    appId: "1:973526886140:web:fe49cdc94034db8e6f9979"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let students = [];
  let users = JSON.parse(localStorage.getItem('users') || '{}');
  let history = JSON.parse(localStorage.getItem('history') || '[]');
  let currentUser = null;

  // Default users si vide
  if(Object.keys(users).length === 0){
    users = {
      "E001": {password: "pass2025", canEdit: true},
      "E002": {password: "pass2026", canEdit: false}
    };
    localStorage.setItem('users', JSON.stringify(users));
  }

  function formatMadagascarDate(d){
    const utc = d.getTime() + (d.getTimezoneOffset() * 60000);
    const madagascarTime = new Date(utc + tzOffsetMadagascar * 60000);
    return madagascarTime.toLocaleString('fr-FR', {dateStyle:'short', timeStyle:'short'});
  }

  function saveUsers(data){
    localStorage.setItem('users', JSON.stringify(data));
  }
  function saveHistory(data){
    localStorage.setItem('history', JSON.stringify(data));
  }

  function addHistory(action){
    const now = new Date();
    const date = formatMadagascarDate(now);
    history.push({date, action});
    saveHistory(history);
    renderHistory();
  }

  function renderStudents(){
    students.sort((a,b) => a.nom.localeCompare(b.nom));
    studentListTbody.innerHTML = '';
    students.forEach((s, idx) => {
      const total = (Number(s.p2025)||0) + (Number(s.p2026)||0) + (Number(s.p2027)||0) + (Number(s.p2028)||0);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td ${currentUser.canEdit ? 'contenteditable="true" aria-label="Nom et prénom de '+s.nom+'"' : ''} data-label="Nom et prénom">${s.nom}</td>
        <td data-label="Matricule">${s.matricule}</td>
        <td ${currentUser.canEdit ? 'contenteditable="true" aria-label="Paiement 2025 de '+s.nom+'"' : ''} data-label="2025 (Ar)">${s.p2025 || 0}</td>
        <td ${currentUser.canEdit ? 'contenteditable="true" aria-label="Paiement 2026 de '+s.nom+'"' : ''} data-label="2026 (Ar)">${s.p2026 || 0}</td>
        <td ${currentUser.canEdit ? 'contenteditable="true" aria-label="Paiement 2027 de '+s.nom+'"' : ''} data-label="2027 (Ar)">${s.p2027 || 0}</td>
        <td ${currentUser.canEdit ? 'contenteditable="true" aria-label="Paiement 2028 de '+s.nom+'"' : ''} data-label="2028 (Ar)">${s.p2028 || 0}</td>
        <td data-label="Total (Ar)"><strong>${total}</strong></td>
        <td data-label="Action">${currentUser.canEdit ? `<button class="btn-delete" aria-label="Supprimer ${s.nom}">Supprimer</button>` : ''}</td>
      `;
      studentListTbody.appendChild(tr);

      if(currentUser.canEdit){
        const cells = tr.querySelectorAll('td[contenteditable="true"]');
        cells.forEach((cell, i) => {
          cell.addEventListener('blur', () => {
            const val = cell.textContent.trim();
            if(i === 0){
              if(val === ''){
                alert('Le nom ne peut pas être vide.');
                cell.textContent = s.nom;
                return;
              }
              s.nom = val;
            } else {
              let n = Number(val);
              if(isNaN(n) || n < 0){
                alert('Le paiement doit être un nombre positif.');
                cell.textContent = s[['p2025','p2026','p2027','p2028'][i-1]] || 0;
                return;
              }
              s[['p2025','p2026','p2027','p2028'][i-1]] = n;
            }
            saveStudentToFirestore(s);
            addHistory(`Modification étudiant ${s.nom} (${s.matricule})`);
            renderStudents();
          });
        });

        const btnDelete = tr.querySelector('.btn-delete');
        btnDelete.addEventListener('click', () => {
          if(confirm(`Supprimer ${s.nom} (${s.matricule}) ?`)){
            // Supprimer dans Firestore
            db.collection("students").doc(s.matricule).delete()
              .then(() => {
                students.splice(idx,1);
                addHistory(`Suppression étudiant ${s.nom} (${s.matricule})`);
                renderStudents();
              })
              .catch(console.error);
          }
        });
      }
    });
  }

  function renderUsers(){
    userListTbody.innerHTML = '';
    Object.entries(users).forEach(([mat, u]) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${mat}</td>
        <td>${'*'.repeat(u.password.length)}</td>
        <td>${u.canEdit ? 'Modification' : 'Lecture seule'}</td>
        <td>${currentUser.canEdit ? `<button class="btn-delete" aria-label="Supprimer utilisateur ${mat}">Supprimer</button>` : ''}</td>
      `;
      userListTbody.appendChild(tr);

      if(currentUser.canEdit){
        const btnDel = tr.querySelector('.btn-delete');
        btnDel.addEventListener('click', () => {
          if(confirm(`Supprimer utilisateur ${mat} ?`)){
            delete users[mat];
            saveUsers(users);
            addHistory(`Suppression utilisateur ${mat}`);
            renderUsers();
          }
        });
      }
    });
  }

  function renderHistory(){
    historyList.innerHTML = '';
    if(history.length === 0){
      historyList.innerHTML = '<li>Aucune action enregistrée.</li>';
      return;
    }
    history.slice().reverse().forEach(h => {
      const li = document.createElement('li');
      li.textContent = `[${h.date}] ${h.action}`;
      historyList.appendChild(li);
    });
  }

  function switchSection(section){
    if(section === 'gestion'){
      gestionSection.style.display = 'block';
      paramsSection.style.display = 'none';
      historySection.style.display = 'none';
      menuGestionBtn.classList.add('active');
      menuParamsBtn.classList.remove('active');
      menuHistoryBtn.classList.remove('active');
      menuGestionBtn.setAttribute('aria-selected', 'true');
      menuParamsBtn.setAttribute('aria-selected', 'false');
      menuHistoryBtn.setAttribute('aria-selected', 'false');
      menuGestionBtn.tabIndex = 0;
      menuParamsBtn.tabIndex = -1;
      menuHistoryBtn.tabIndex = -1;
    } else if(section === 'params'){
      gestionSection.style.display = 'none';
      paramsSection.style.display = 'block';
      historySection.style.display = 'none';
      menuGestionBtn.classList.remove('active');
      menuParamsBtn.classList.add('active');
      menuHistoryBtn.classList.remove('active');
      menuGestionBtn.setAttribute('aria-selected', 'false');
      menuParamsBtn.setAttribute('aria-selected', 'true');
      menuHistoryBtn.setAttribute('aria-selected', 'false');
      menuGestionBtn.tabIndex = -1;
      menuParamsBtn.tabIndex = 0;
      menuHistoryBtn.tabIndex = -1;
    } else {
      gestionSection.style.display = 'none';
      paramsSection.style.display = 'none';
      historySection.style.display = 'block';
      menuGestionBtn.classList.remove('active');
      menuParamsBtn.classList.remove('active');
      menuHistoryBtn.classList.add('active');
      menuGestionBtn.setAttribute('aria-selected', 'false');
      menuParamsBtn.setAttribute('aria-selected', 'false');
      menuHistoryBtn.setAttribute('aria-selected', 'true');
      menuGestionBtn.tabIndex = -1;
      menuParamsBtn.tabIndex = -1;
      menuHistoryBtn.tabIndex = 0;
    }
  }

  // --- Firebase : Chargement des étudiants au démarrage
  function loadStudentsFromFirestore() {
    db.collection("students").onSnapshot((snapshot) => {
      students = [];
      snapshot.forEach(doc => {
        students.push(doc.data());
      });
      renderStudents();
    });
  }

  // --- Sauvegarde d’un étudiant dans Firestore
  function saveStudentToFirestore(student) {
    db.collection("students").doc(student.matricule).set(student)
      .then(() => {
        //console.log("Étudiant sauvegardé dans Firestore");
      })
      .catch(console.error);
  }

  // --- Formulaire Ajout étudiant
  addStudentForm.addEventListener('submit', e => {
    e.preventDefault();
    if(!currentUser.canEdit) return;

    const nom = document.getElementById('addNom').value.trim();
    const matricule = document.getElementById('addMatricule').value.trim();
    const p2025 = Number(document.getElementById('add2025').value);
    const p2026 = Number(document.getElementById('add2026').value);
    const p2027 = Number(document.getElementById('add2027').value);
    const p2028 = Number(document.getElementById('add2028').value);

    if(nom === '' || matricule === '') {
      alert("Nom et matricule sont obligatoires");
      return;
    }
    if(students.find(s => s.matricule === matricule)) {
      alert("Ce matricule existe déjà.");
      return;
    }

    const newStudent = {nom, matricule, p2025, p2026, p2027, p2028};
    students.push(newStudent);
    saveStudentToFirestore(newStudent);
    addHistory(`Ajout étudiant ${nom} (${matricule})`);
    renderStudents();
    addStudentForm.reset();
  });

  // --- Formulaire Ajout utilisateur
  addUserForm.addEventListener('submit', e => {
    e.preventDefault();
    if(!currentUser.canEdit) return;

    const matricule = document.getElementById('addUserMatricule').value.trim();
    const password = document.getElementById('addUserPassword').value.trim();
    const canEdit = document.getElementById('addUserRight').value === 'edit';

    if(matricule === '' || password === '') {
      alert("Matricule et mot de passe sont obligatoires");
      return;
    }
    if(users[matricule]) {
      alert("Ce matricule existe déjà.");
      return;
    }
    users[matricule] = {password, canEdit};
    saveUsers(users);
    addHistory(`Ajout utilisateur ${matricule}`);
    renderUsers();
    addUserForm.reset();
  });

  // --- Login
  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    const matricule = document.getElementById('loginMatricule').value.trim();
    const password = document.getElementById('loginPassword').value.trim();

    if(users[matricule] && users[matricule].password === password) {
      currentUser = {matricule, canEdit: users[matricule].canEdit};
      loginSection.style.display = 'none';
      mainSection.style.display = 'block';
      if(currentUser.canEdit){
        menuParamsBtn.style.display = 'inline-block';
        menuHistoryBtn.style.display = 'inline-block';
      }
      switchSection('gestion');
      renderStudents();
      renderUsers();
      renderHistory();
    } else {
      loginError.style.display = 'block';
    }
  });

  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    loginError.style.display = 'none';
    loginSection.style.display = 'block';
    mainSection.style.display = 'none';
    menuParamsBtn.style.display = 'none';
    menuHistoryBtn.style.display = 'none';
  });

  menuGestionBtn.addEventListener('click', () => switchSection('gestion'));
  menuParamsBtn.addEventListener('click', () => switchSection('params'));
  menuHistoryBtn.addEventListener('click', () => switchSection('history'));

  // Charge les étudiants depuis Firestore au démarrage
  loadStudentsFromFirestore();
})();
</script>
</body>
</html>
