<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestion Paiements Étudiants - Médecine</title>
<style>
  /* Ton CSS EXACT */
  /* ... (le même CSS que dans ton code, je le garde tel quel ici, pour la lisibilité, remplace avec ton CSS complet) */
  /* Copie-colle ici tout ton CSS déjà fourni dans ton code */
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');
  * { box-sizing: border-box; }
  body {
    margin:0; padding:0; background:#f4f9ff;
    font-family: 'Montserrat', sans-serif;
    color:#333;
    display:flex; justify-content:center; align-items:center;
    min-height:100vh;
  }
  #app {
    background:white;
    width:95vw;
    max-width:1000px;
    border-radius:15px;
    box-shadow:0 8px 20px rgb(0 123 255 / 0.2);
    overflow:hidden;
  }
  header {
    background:#007bff;
    color:white;
    padding:1rem 2rem;
    display:flex;
    align-items:center;
    gap:1rem;
    box-shadow: inset 0 -4px 8px rgb(0 0 0 / 0.1);
  }
  header svg {
    width:36px; height:36px;
    fill:#a6d8ff;
  }
  header h1 {
    font-weight:600;
    font-size:1.5rem;
    margin:0;
  }
  #loginSection, #mainSection {
    padding:1rem 2rem 2rem 2rem;
  }
  #loginSection {
    max-width:400px;
    margin:4rem auto;
    background:white;
    border-radius:15px;
    box-shadow:0 8px 20px rgb(0 123 255 / 0.15);
    text-align:center;
  }
  #loginSection h1 {
    margin-bottom:1.5rem;
    font-weight:600;
    color:#007bff;
  }
  #loginForm input {
    display:block;
    width:100%;
    margin-bottom:1rem;
    padding:0.8rem;
    font-size:1rem;
    border-radius:8px;
    border:1px solid #ccc;
    transition: border-color 0.3s;
  }
  #loginForm input:focus {
    outline:none;
    border-color:#007bff;
    box-shadow:0 0 6px #007bffaa;
  }
  #loginForm button {
    width:100%;
    background:#007bff;
    color:white;
    border:none;
    font-weight:600;
    font-size:1rem;
    padding:0.8rem;
    border-radius:8px;
    cursor:pointer;
    transition: background 0.3s;
  }
  #loginForm button:hover {
    background:#0056b3;
  }
  #loginError {
    color:#d9534f;
    margin-top:0.5rem;
    display:none;
  }
  #logoutBtn {
    background:#dc3545;
    color:white;
    border:none;
    border-radius:12px;
    padding:0.5rem 1rem;
    font-weight:600;
    cursor:pointer;
    float:right;
    margin-bottom:1rem;
    display:flex;
    align-items:center;
    gap:0.5rem;
    transition: background 0.3s;
  }
  #logoutBtn:hover {
    background:#b02a37;
  }
  #logoutBtn svg {
    width:20px; height:20px;
    fill:white;
  }
  nav {
    display:flex;
    gap:1rem;
    margin-bottom:1rem;
  }
  nav button {
    flex-grow:1;
    padding:0.8rem;
    background:#e7f0ff;
    border:none;
    border-radius:12px;
    font-weight:600;
    cursor:pointer;
    color:#007bff;
    transition: background 0.3s, color 0.3s;
  }
  nav button.active,
  nav button:hover {
    background:#007bff;
    color:white;
  }
  table {
    width:100%;
    border-collapse:collapse;
    margin-bottom:1rem;
    font-size:0.9rem;
  }
  th, td {
    text-align:center;
    padding:0.6rem 0.8rem;
    border-bottom:1px solid #ddd;
    vertical-align:middle;
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  tbody tr:hover {
    background:#f1f9ff;
  }
  td[contenteditable="true"] {
    background:#e7f0ff;
    border-radius:6px;
    cursor:text;
    font-family: monospace;
    text-align: right;
    padding-right: 10px;
  }
  td[contenteditable="true"]:focus {
    outline:2px solid #0056b3;
    background:#cce4ff;
  }
  tbody tr td[data-label="Nom et prénom"] {
    max-width: 200px;
    white-space: nowrap;
  }
  .btn-delete {
    background:#dc3545;
    border:none;
    color:white;
    padding:0.3rem 0.6rem;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    transition: background 0.3s;
  }
  .btn-delete:hover {
    background:#a71d2a;
  }
  form.addForm {
    display:flex;
    gap:0.6rem;
    flex-wrap:wrap;
    margin-bottom:2rem;
  }
  form.addForm input,
  form.addForm select,
  form.addForm button {
    padding:0.5rem 0.8rem;
    font-size:0.9rem;
    border-radius:8px;
    border:1px solid #ccc;
    flex:1 1 120px;
  }
  form.addForm button {
    background:#28a745;
    border:none;
    color:white;
    font-weight:600;
    cursor:pointer;
    flex:1 1 120px;
    transition: background 0.3s;
  }
  form.addForm button:hover {
    background:#1e7e34;
  }
  @media (max-width: 720px) {
    table, thead, tbody, th, td, tr {
      display:block;
    }
    thead tr {
      display:none;
    }
    tbody tr {
      margin-bottom:1rem;
      border-radius:12px;
      box-shadow:0 4px 8px rgb(0 123 255 / 0.1);
      background:white;
      padding:1rem;
    }
    tbody tr td {
      display:flex;
      justify-content:space-between;
      padding:0.6rem 1rem;
      border:none;
      border-bottom:1px solid #eee;
      text-align:left;
      white-space: normal;
    }
    tbody tr td:last-child {
      border-bottom:none;
    }
    tbody tr td::before {
      content: attr(data-label);
      font-weight:600;
      color:#007bff;
    }
    form.addForm {
      flex-direction:column;
    }
  }
</style>
</head>
<body>

<div id="app">
  <section id="loginSection" role="dialog" aria-modal="true" aria-labelledby="loginTitle" aria-describedby="loginDesc">
    <h1 id="loginTitle">Connexion requise</h1>
    <p id="loginDesc">Veuillez entrer votre email et mot de passe pour accéder au site.</p>
    <form id="loginForm" aria-label="Formulaire de connexion">
      <input type="email" id="loginEmail" placeholder="Email" required autocomplete="off" aria-required="true" aria-label="Email" />
      <input type="password" id="loginPassword" placeholder="Mot de passe" required autocomplete="off" aria-required="true" aria-label="Mot de passe" />
      <button type="submit" aria-label="Se connecter">Se connecter</button>
    </form>
    <p id="loginError" role="alert" aria-live="assertive" style="display:none; color:#d9534f; margin-top:0.5rem;">Email ou mot de passe incorrect.</p>
  </section>

  <section id="mainSection" style="display:none;" aria-live="polite">

    <button id="logoutBtn" title="Déconnexion" aria-label="Bouton déconnexion" style="margin-bottom:1rem;">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" style="width:18px; height:18px; vertical-align:middle; margin-right:0.3rem;"><path d="M19 7v10a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2v-3H5v3a4 4 0 0 0 4 4h8a4 4 0 0 0 4-4V7z"/><path d="M16 12H7m5-5l-5 5 5 5" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Déconnexion
    </button>

    <header>
      <svg aria-hidden="true" focusable="false" viewBox="0 0 64 64" width="36" height="36" style="flex-shrink:0; margin-right:1rem;">
        <path d="M53.2 15.8a3 3 0 0 0-2.7-1.7 3 3 0 0 0-2.5 1.2l-4.4 6.1a.5.5 0 0 1-.87-.33l-1-7.2a3 3 0 0 0-1.6-2.5l-10-5.8a2.97 2.97 0 0 0-3 .5 2.96 2.96 0 0 0-.92 2.4l.15 12.4-11.4 7.7a2.94 2.94 0 0 0-1 2.2 2.95 2.95 0 0 0 2.9 2.9 2.9 2.9 0 0 0 1.7-.52l11.4-7.7v17.6a5 5 0 1 0 4 0V23.4l4.4-6.1a.5.5 0 0 1 .87.33l1 7.2a3 3 0 0 0 1.6 2.5l10 5.8a3.02 3.02 0 0 0 4.1-3.3z" fill="#3a9ad9"/>
      </svg>
      <h1>Gestion paiements étudiants</h1>
    </header>

    <nav role="tablist" aria-label="Navigation principale" style="margin:1rem 0;">
      <button id="btnGestion" class="active" aria-controls="gestionSection" aria-selected="true" role="tab" tabindex="0">Gestion</button>
      <button id="btnParams" style="display:none;" aria-controls="paramsSection" aria-selected="false" role="tab" tabindex="-1">Paramètres</button>
      <button id="btnHistory" style="display:none;" aria-controls="historySection" aria-selected="false" role="tab" tabindex="-1">Historique</button>
    </nav>

    <section id="gestionSection" role="tabpanel" tabindex="0" aria-label="Gestion des étudiants">
      <table aria-label="Liste des étudiants">
        <thead>
          <tr>
            <th>Nom et prénom</th>
            <th>Matricule</th>
            <th>2025 (Ar)</th>
            <th>2026 (Ar)</th>
            <th>2027 (Ar)</th>
            <th>2028 (Ar)</th>
            <th>Total (Ar)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="studentList"></tbody>
      </table>

      <form id="addStudentForm" class="addForm" aria-label="Formulaire d'ajout d'étudiant">
        <input type="text" id="addNom" placeholder="Nom et prénom" required autocomplete="off" aria-required="true" aria-label="Nom et prénom" />
        <input type="text" id="addMatricule" placeholder="Matricule" required autocomplete="off" aria-required="true" aria-label="Matricule" />
        <input type="number" id="add2025" placeholder="2025" min="0" value="0" required aria-label="Paiement 2025" />
        <input type="number" id="add2026" placeholder="2026" min="0" value="0" required aria-label="Paiement 2026" />
        <input type="number" id="add2027" placeholder="2027" min="0" value="0" required aria-label="Paiement 2027" />
        <input type="number" id="add2028" placeholder="2028" min="0" value="0" required aria-label="Paiement 2028" />
        <button type="submit" id="addStudentBtn">Ajouter</button>
      </form>
    </section>

    <section id="paramsSection" role="tabpanel" tabindex="0" style="display:none;" aria-label="Paramètres">
      <h2>Gestion des utilisateurs</h2>
      <table aria-label="Liste des utilisateurs">
        <thead>
          <tr>
            <th>Email</th>
            <th>Droits</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="userList"></tbody>
      </table>

      <form id="addUserForm" class="addForm" aria-label="Formulaire d'ajout d'utilisateur">
        <input type="email" id="addUserEmail" placeholder="Email" required autocomplete="off" aria-required="true" aria-label="Email utilisateur" />
        <select id="addUserRight" required aria-label="Droits utilisateur">
          <option value="" disabled selected>Choisir droits</option>
          <option value="edit">Peut modifier</option>
          <option value="read">Lecture seule</option>
        </select>
        <button type="submit" id="addUserBtn">Ajouter utilisateur</button>
      </form>
    </section>

    <section id="historySection" role="tabpanel" tabindex="0" style="display:none;" aria-label="Historique">
      <h2>Historique des modifications</h2>
      <ul id="historyList" style="max-height:300px;overflow:auto;padding-left:1rem;"></ul>
    </section>

  </section>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
(() => {
  const tzOffsetMadagascar = 3 * 60; // +3h en minutes

  // Firebase config - mets ici tes propres infos
  const firebaseConfig = {
  apiKey: "AIzaSyDW8_PXm8MpM-NSANtFqIL4egHN9DjtJUo",
  authDomain: "gestion-paiements-medecine.firebaseapp.com",
  databaseURL: "https://gestion-paiements-medecine-default-rtdb.firebaseio.com",
  projectId: "gestion-paiements-medecine",
  storageBucket: "gestion-paiements-medecine.firebasestorage.app",
  messagingSenderId: "973526886140",
  appId: "1:973526886140:web:fe49cdc94034db8e6f9979"

  };

  // Initialise Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // DOM Elements
  const loginSection = document.getElementById('loginSection');
  const loginForm = document.getElementById('loginForm');
  const loginError = document.getElementById('loginError');
  const mainSection = document.getElementById('mainSection');
  const logoutBtn = document.getElementById('logoutBtn');
  const menuGestionBtn = document.getElementById('btnGestion');
  const menuParamsBtn = document.getElementById('btnParams');
  const menuHistoryBtn = document.getElementById('btnHistory');
  const gestionSection = document.getElementById('gestionSection');
  const paramsSection = document.getElementById('paramsSection');
  const historySection = document.getElementById('historySection');
  const studentListTbody = document.getElementById('studentList');
  const addStudentForm = document.getElementById('addStudentForm');
  const userListTbody = document.getElementById('userList');
  const addUserForm = document.getElementById('addUserForm');
  const historyList = document.getElementById('historyList');

  // Etat courant
  let currentUser = null;
  let users = {};    // objet {email: {canEdit: bool}}
  let history = [];  // tableau des actions

  // Formater date locale Madagascar
  function formatMadagascarDate(d) {
    const utc = d.getTime() + (d.getTimezoneOffset() * 60000);
    const madagascarTime = new Date(utc + tzOffsetMadagascar * 60000);
    return madagascarTime.toLocaleString('fr-FR', {dateStyle:'short', timeStyle:'short'});
  }

  // Afficher ou cacher une section avec gestion des tabIndex et aria
  function switchTab(newBtn, newSection) {
    [menuGestionBtn, menuParamsBtn, menuHistoryBtn].forEach(btn => {
      btn.classList.remove('active');
      btn.setAttribute('aria-selected', 'false');
      btn.tabIndex = -1;
    });
    [gestionSection, paramsSection, historySection].forEach(sec => sec.style.display = 'none');

    newBtn.classList.add('active');
    newBtn.setAttribute('aria-selected', 'true');
    newBtn.tabIndex = 0;
    newSection.style.display = 'block';
    newSection.focus();
  }

  // Récupérer les droits d’un utilisateur depuis Firestore
  async function loadUsers() {
    const snapshot = await db.collection('users').get();
    users = {};
    snapshot.forEach(doc => {
      users[doc.id] = doc.data();
    });
    renderUserList();
  }

  // Rendre la liste utilisateurs
  function renderUserList() {
    userListTbody.innerHTML = '';
    Object.entries(users).forEach(([email, data]) => {
      const tr = document.createElement('tr');
      const tdEmail = document.createElement('td');
      tdEmail.textContent = email;
      const tdRight = document.createElement('td');
      tdRight.textContent = data.right || 'lecture seule';
      const tdAction = document.createElement('td');
      if(email !== currentUser.email){
        const btnDel = document.createElement('button');
        btnDel.className = 'btn-delete';
        btnDel.textContent = 'Supprimer';
        btnDel.onclick = () => deleteUser(email);
        tdAction.appendChild(btnDel);
      }
      tr.appendChild(tdEmail);
      tr.appendChild(tdRight);
      tr.appendChild(tdAction);
      userListTbody.appendChild(tr);
    });
  }

  async function deleteUser(email) {
    if(confirm(`Supprimer l'utilisateur ${email} ?`)) {
      await db.collection('users').doc(email).delete();
      await loadUsers();
      addHistory(`Suppression de l'utilisateur ${email}`);
    }
  }

  // Charger les étudiants
  async function loadStudents() {
    const snapshot = await db.collection('students').orderBy('nom').get();
    studentListTbody.innerHTML = '';
    snapshot.forEach(doc => {
      const student = doc.data();
      const tr = createStudentRow(doc.id, student);
      studentListTbody.appendChild(tr);
    });
  }

  // Créer une ligne étudiant
  function createStudentRow(id, student) {
    const tr = document.createElement('tr');
    // Nom prénom
    const tdNom = document.createElement('td');
    tdNom.textContent = student.nom;
    tdNom.setAttribute('data-label', 'Nom et prénom');
    tdNom.contentEditable = users[currentUser.email]?.right === 'edit';
    tdNom.spellcheck = false;
    tdNom.onblur = () => updateStudentField(id, 'nom', tdNom.textContent.trim());

    // Matricule
    const tdMatricule = document.createElement('td');
    tdMatricule.textContent = student.matricule;
    tdMatricule.setAttribute('data-label', 'Matricule');
    tdMatricule.contentEditable = users[currentUser.email]?.right === 'edit';
    tdMatricule.spellcheck = false;
    tdMatricule.onblur = () => updateStudentField(id, 'matricule', tdMatricule.textContent.trim());

    // Paiements
    const years = ['2025', '2026', '2027', '2028'];
    const tdYears = years.map(year => {
      const td = document.createElement('td');
      td.setAttribute('data-label', year + ' (Ar)');
      td.contentEditable = users[currentUser.email]?.right === 'edit';
      td.spellcheck = false;
      td.textContent = student[year] ?? '0';
      td.onblur = () => {
        let val = parseInt(td.textContent.trim());
        if(isNaN(val) || val < 0) val = 0;
        td.textContent = val;
        updateStudentField(id, year, val);
      };
      return td;
    });

    // Total
    const tdTotal = document.createElement('td');
    tdTotal.setAttribute('data-label', 'Total (Ar)');
    const total = years.reduce((acc,y) => acc + (parseInt(student[y]) || 0), 0);
    tdTotal.textContent = total;

    // Action delete
    const tdAction = document.createElement('td');
    if(users[currentUser.email]?.right === 'edit'){
      const btnDel = document.createElement('button');
      btnDel.className = 'btn-delete';
      btnDel.textContent = 'Supprimer';
      btnDel.onclick = () => deleteStudent(id);
      tdAction.appendChild(btnDel);
    }

    // Append all cells
    tr.appendChild(tdNom);
    tr.appendChild(tdMatricule);
    tdYears.forEach(td => tr.appendChild(td));
    tr.appendChild(tdTotal);
    tr.appendChild(tdAction);
    return tr;
  }

  // Ajouter un étudiant
  addStudentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if(users[currentUser.email]?.right !== 'edit'){
      alert('Vous n\'avez pas les droits pour ajouter.');
      return;
    }
    const nom = document.getElementById('addNom').value.trim();
    const matricule = document.getElementById('addMatricule').value.trim();
    const pay2025 = parseInt(document.getElementById('add2025').value) || 0;
    const pay2026 = parseInt(document.getElementById('add2026').value) || 0;
    const pay2027 = parseInt(document.getElementById('add2027').value) || 0;
    const pay2028 = parseInt(document.getElementById('add2028').value) || 0;
    if(!nom || !matricule){
      alert('Nom et matricule sont obligatoires.');
      return;
    }
    const studentData = {
      nom,
      matricule,
      '2025': pay2025,
      '2026': pay2026,
      '2027': pay2027,
      '2028': pay2028
    };
    try {
      await db.collection('students').add(studentData);
      addStudentForm.reset();
      await loadStudents();
      addHistory(`Ajout étudiant ${nom}`);
    } catch(e) {
      alert('Erreur ajout étudiant : ' + e.message);
    }
  });

  // Supprimer étudiant
  async function deleteStudent(id) {
    if(confirm('Supprimer cet étudiant ?')){
      await db.collection('students').doc(id).delete();
      await loadStudents();
      addHistory(`Suppression étudiant ID=${id}`);
    }
  }

  // Mise à jour champ étudiant
  async function updateStudentField(id, field, value) {
    if(users[currentUser.email]?.right !== 'edit'){
      alert('Vous n\'avez pas les droits pour modifier.');
      await loadStudents();
      return;
    }
    try {
      await db.collection('students').doc(id).update({[field]: value});
      addHistory(`Modification étudiant ID=${id}, champ ${field} => ${value}`);
      await loadStudents(); // pour recalcul total etc
    } catch(e) {
      alert('Erreur mise à jour : ' + e.message);
    }
  }

  // Ajouter utilisateur (dans Firestore)
  addUserForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if(users[currentUser.email]?.right !== 'edit'){
      alert('Vous n\'avez pas les droits pour ajouter utilisateur.');
      return;
    }
    const email = document.getElementById('addUserEmail').value.trim();
    const right = document.getElementById('addUserRight').value;
    if(!email || !right) {
      alert('Email et droits sont obligatoires.');
      return;
    }
    try {
      await db.collection('users').doc(email).set({right});
      await loadUsers();
      addUserForm.reset();
      addHistory(`Ajout utilisateur ${email} droits=${right}`);
    } catch(e) {
      alert('Erreur ajout utilisateur : ' + e.message);
    }
  });

  // Historique
  async function loadHistory() {
    const snapshot = await db.collection('history').orderBy('date', 'desc').limit(100).get();
    historyList.innerHTML = '';
    snapshot.forEach(doc => {
      const h = doc.data();
      const li = document.createElement('li');
      li.textContent = `[${formatMadagascarDate(h.date.toDate())}] ${h.action}`;
      historyList.appendChild(li);
    });
  }

  async function addHistory(action) {
    try {
      await db.collection('history').add({
        action,
        date: firebase.firestore.Timestamp.fromDate(new Date())
      });
      await loadHistory();
    } catch(e) {
      console.error('Erreur ajout historique:', e);
    }
  }

  // Événements menu
  menuGestionBtn.onclick = () => switchTab(menuGestionBtn, gestionSection);
  menuParamsBtn.onclick = () => switchTab(menuParamsBtn, paramsSection);
  menuHistoryBtn.onclick = () => switchTab(menuHistoryBtn, historySection);

  // Déconnexion
  logoutBtn.onclick = () => auth.signOut();

  // Connexion
  loginForm.onsubmit = async (e) => {
    e.preventDefault();
    loginError.style.display = 'none';
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    try {
      await auth.signInWithEmailAndPassword(email, password);
    } catch(err) {
      loginError.style.display = 'block';
      console.error('Erreur connexion:', err);
    }
  };

  // Gestion auth state
  auth.onAuthStateChanged(async (user) => {
    if(user){
      currentUser = user;
      loginSection.style.display = 'none';
      mainSection.style.display = 'block';

      // Charger droits utilisateurs
      await loadUsers();

      // Si utilisateur pas en base, on le crée en lecture seule par défaut
      if(!users[currentUser.email]){
        await db.collection('users').doc(currentUser.email).set({right:'read'});
        await loadUsers();
      }

      // Afficher ou cacher menu paramètres selon droit
      if(users[currentUser.email]?.right === 'edit'){
        menuParamsBtn.style.display = 'inline-block';
      } else {
        menuParamsBtn.style.display = 'none';
        // Si actif, bascule sur gestion
        if(menuParamsBtn.classList.contains('active')){
          switchTab(menuGestionBtn, gestionSection);
        }
      }

      // Charger données étudiants
      await loadStudents();
      await loadHistory();

      // Activer/désactiver le formulaire ajout étudiant selon droit
      addStudentForm.querySelectorAll('input,button').forEach(el => {
        el.disabled = users[currentUser.email]?.right !== 'edit';
      });

      // Activer/désactiver formulaire ajout utilisateur
      addUserForm.querySelectorAll('input,select,button').forEach(el => {
        el.disabled = users[currentUser.email]?.right !== 'edit';
      });

    } else {
      currentUser = null;
      loginSection.style.display = 'block';
      mainSection.style.display = 'none';
      loginForm.reset();
      loginError.style.display = 'none';
    }
  });

})();
</script>

</body>
</html>
